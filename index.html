<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OMS Demo â€“ Business Dashboard & In-Browser SQL</title>
  <!-- Tailwind CSS CDN -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <!-- sql.js library for in-browser SQLite -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
  <!-- Chart.js for charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* Hide all views by default */
    .view { display: none; }
    /* Order card hover effect */
    .order-card:hover { background-color: #f0f8ff; cursor: pointer; }
  </style>
</head>
<body class="bg-gray-100">
  <!-- Navigation Bar -->
  <nav class="bg-white shadow p-4 mb-4">
    <div class="container mx-auto flex justify-between items-center">
      <div>
        <a href="#" onclick="showView('dashboard')" class="mr-4 text-blue-600">Dashboard</a>
        <a href="#" onclick="showView('aiInsights')" class="mr-4 text-blue-600">AI Insights</a>
        <a href="#" onclick="showView('newOrder')" class="mr-4 text-blue-600">New Order</a>
        <!-- Admin Dashboard and DB Ops links should be hidden for non-admin users -->
        <a href="#" id="adminLink" onclick="showView('adminDashboard')" class="mr-4 text-blue-600" style="display:none;">Admin Dashboard</a>
        <a href="#" id="dbOpsLink" onclick="showView('dbOps')" class="mr-4 text-blue-600" style="display:none;">DB Ops</a>
      </div>
      <div id="navAuth">
        <a href="#" id="navLogin" onclick="showView('login')" class="mr-4 text-blue-600">Login</a>
        <a href="#" id="navSignup" onclick="showView('signup')" class="mr-4 text-blue-600">Sign Up</a>
        <a href="#" id="navLogout" onclick="logout()" style="display:none;" class="mr-4 text-blue-600">Logout</a>
      </div>
    </div>
  </nav>

  <!-- LOGIN VIEW -->
  <div id="login" class="view">
    <div class="flex min-h-screen items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-50 p-4">
      <form id="loginForm" class="w-full max-w-md rounded-2xl bg-white p-8 shadow-xl">
        <h1 class="mb-8 text-center text-3xl font-bold text-gray-800">Welcome Back</h1>
        <div class="space-y-6">
          <div class="space-y-2">
            <label class="block text-sm font-medium text-gray-700">Email</label>
            <input type="email" id="loginEmail" placeholder="Enter your email" required class="w-full px-4 py-3 border rounded-lg" />
          </div>
          <div class="space-y-2">
            <label class="block text-sm font-medium text-gray-700">Password</label>
            <input type="password" id="loginPassword" placeholder="Enter your password" required class="w-full px-4 py-3 border rounded-lg" />
          </div>
          <div id="loginError" class="text-sm text-red-500"></div>
          <button type="submit" class="w-full rounded-lg bg-blue-600 px-4 py-3 text-white">Sign In</button>
          <p class="text-center text-sm text-gray-600">
            Don't have an account?
            <a href="#" onclick="showView('signup')" class="text-blue-600 hover:underline">Sign up</a>
          </p>
        </div>
      </form>
    </div>
  </div>

  <!-- SIGN UP VIEW -->
  <div id="signup" class="view">
    <div class="flex min-h-screen items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-50 p-4">
      <form id="signupForm" class="w-full max-w-md rounded-2xl bg-white p-8 shadow-xl">
        <h1 class="mb-8 text-center text-3xl font-bold text-gray-800">Create Account</h1>
        <div class="space-y-6">
          <div class="space-y-2">
            <label class="block text-sm font-medium text-gray-700">Email</label>
            <input type="email" id="signupEmail" placeholder="Enter your email" required class="w-full px-4 py-3 border rounded-lg" />
          </div>
          <div class="space-y-2">
            <label class="block text-sm font-medium text-gray-700">Password</label>
            <input type="password" id="signupPassword" placeholder="Enter your password" required class="w-full px-4 py-3 border rounded-lg" />
          </div>
          <div id="signupError" class="text-sm text-red-500"></div>
          <button type="submit" class="w-full rounded-lg bg-blue-600 px-4 py-3 text-white">Sign Up</button>
          <p class="text-center text-sm text-gray-600">
            Already have an account?
            <a href="#" onclick="showView('login')" class="text-blue-600 hover:underline">Sign in</a>
          </p>
        </div>
      </form>
    </div>
  </div>

  <!-- DASHBOARD VIEW WITH ANALYTICS PANEL -->
  <div id="dashboard" class="view">
    <div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-50 p-6">
      <div class="mx-auto max-w-6xl">
        <!-- User Info -->
        <div class="mb-8 flex items-center justify-between">
          <div class="flex items-center gap-4">
            <span id="userEmailDisplay" class="text-xl font-bold text-gray-800"></span>
            <span id="userRoleDisplay" class="rounded-full bg-blue-100 px-3 py-1 text-sm text-blue-800"></span>
          </div>
          <button onclick="logout()" class="text-gray-600 hover:text-gray-800">Sign Out</button>
        </div>
        <!-- Analytics Panels -->
        <div id="dashboardAnalytics" class="mb-8">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Order Summary KPI -->
            <div class="bg-white p-6 rounded-lg shadow-lg">
              <h2 class="text-xl font-bold text-gray-800 mb-4">Order Summary</h2>
              <p>Total Orders: <span id="totalOrders">0</span></p>
              <p>Pending: <span id="pendingOrders">0</span></p>
              <p>Processing: <span id="processingOrders">0</span></p>
              <p>Manufacturing: <span id="manufacturingOrders">0</span></p>
              <p>Delivered: <span id="completedOrders">0</span></p>
              <p>Cancelled: <span id="cancelledOrders">0</span></p>
            </div>
            <!-- Logistics & Manufacturing KPI (sample static values) -->
            <div class="bg-white p-6 rounded-lg shadow-lg">
              <h2 class="text-xl font-bold text-gray-800 mb-4">Logistics & Manufacturing KPIs</h2>
              <p>Average Processing Time: <strong>3 days</strong></p>
              <p>On-Time Delivery Rate: <strong>92%</strong></p>
              <p>Order Cycle Time: <strong>5 days</strong></p>
              <p>Inventory Turnover: <strong>12x</strong></p>
            </div>
          </div>
          <!-- Pie Chart for Order Status -->
          <div class="mt-6 bg-white p-6 rounded-lg shadow-lg">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Orders by Status</h2>
            <div style="height:200px;">
              <canvas id="dashboardPieChart"></canvas>
            </div>
          </div>
        </div>
        <!-- Dashboard Content -->
        <div id="dashboardContent">
          <!-- Customer Dashboard -->
          <div id="customerDashboard" style="display:none;">
            <div class="flex justify-between mb-4">
              <h2 class="text-2xl font-bold text-gray-800">My Orders</h2>
              <button onclick="showView('newOrder')" class="rounded-lg bg-blue-600 px-4 py-2 text-white">New Order</button>
            </div>
            <div id="customerOrdersContainer" class="rounded-lg bg-white p-6 shadow-lg">
              <div class="text-center text-gray-500">No orders yet</div>
            </div>
          </div>
          <!-- Factory Dashboard -->
          <div id="factoryDashboard" style="display:none;">
            <div class="flex justify-between mb-4">
              <h2 class="text-2xl font-bold text-gray-800">Orders for Manufacturing</h2>
            </div>
            <div id="factoryOrdersContainer" class="rounded-lg bg-white p-6 shadow-lg">
              <div class="text-center text-gray-500">No orders available</div>
            </div>
          </div>
          <!-- Admin Dashboard -->
          <div id="adminDashboardContent" style="display:none;">
            <div class="flex justify-between mb-4">
              <h2 class="text-2xl font-bold text-gray-800">All Orders</h2>
              <button onclick="showView('newOrder')" class="rounded-lg bg-blue-600 px-4 py-2 text-white">Create Order</button>
            </div>
            <div id="adminOrdersContainer" class="rounded-lg bg-white p-6 shadow-lg">
              <div class="text-center text-gray-500">No orders yet</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- AI INSIGHTS VIEW -->
  <div id="aiInsights" class="view">
    <div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-50 p-6">
      <div class="mx-auto max-w-4xl">
        <h1 class="text-3xl font-bold text-gray-800 mb-4">AI Insights</h1>
        <p class="mb-6 text-gray-600">Based on our AI-powered analysis, here are some predictions and trends:</p>
        <div class="bg-white p-6 rounded-lg shadow-xl">
          <canvas id="aiChart" width="400" height="200"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- NEW ORDER VIEW -->
  <div id="newOrder" class="view">
    <div class="flex min-h-screen w-full bg-gradient-to-br from-blue-50 to-indigo-50 p-4">
      <div class="mx-auto w-full max-w-4xl">
        <div class="mb-8">
          <h1 class="text-3xl font-bold text-gray-800">New Order</h1>
          <p class="text-gray-600">Please fill in the order details below</p>
        </div>
        <div class="grid gap-8 md:grid-cols-2">
          <form id="newOrderForm" class="space-y-6">
            <div class="rounded-2xl bg-white p-6 shadow-xl">
              <div class="space-y-4">
                <div class="space-y-2">
                  <label class="block text-sm font-medium text-gray-700">Customer Name</label>
                  <input type="text" name="customerName" required placeholder="Enter customer name" class="w-full px-4 py-3 border rounded-lg" />
                </div>
                <div class="space-y-2">
                  <label class="block text-sm font-medium text-gray-700">Email</label>
                  <input type="email" name="email" required placeholder="Enter email address" class="w-full px-4 py-3 border rounded-lg" />
                </div>
                <div class="space-y-2">
                  <label class="block text-sm font-medium text-gray-700">Product Name</label>
                  <input type="text" name="productName" required placeholder="Enter product name" class="w-full px-4 py-3 border rounded-lg" />
                </div>
                <div class="space-y-2">
                  <label class="block text-sm font-medium text-gray-700">Quantity</label>
                  <input type="number" name="quantity" min="1" required class="w-full px-4 py-3 border rounded-lg" />
                </div>
                <div class="space-y-2">
                  <label class="block text-sm font-medium text-gray-700">Special Instructions</label>
                  <textarea name="specialInstructions" rows="4" placeholder="Enter any special instructions" class="w-full px-4 py-3 border rounded-lg"></textarea>
                </div>
              </div>
            </div>
            <div id="newOrderError" class="text-sm text-red-500"></div>
            <button type="submit" class="w-full rounded-lg bg-blue-600 px-4 py-3 text-white">Submit Order</button>
          </form>
          <div class="rounded-2xl bg-white p-6 shadow-xl">
            <h2 class="mb-4 text-xl font-bold text-gray-800">Order Preview</h2>
            <div class="space-y-4">
              <div>
                <span class="font-medium text-gray-700">Customer Name:</span>
                <p id="previewCustomerName" class="text-gray-600">-</p>
              </div>
              <div>
                <span class="font-medium text-gray-700">Email:</span>
                <p id="previewEmail" class="text-gray-600">-</p>
              </div>
              <div>
                <span class="font-medium text-gray-700">Product:</span>
                <p id="previewProductName" class="text-gray-600">-</p>
              </div>
              <div>
                <span class="font-medium text-gray-700">Quantity:</span>
                <p id="previewQuantity" class="text-gray-600">1</p>
              </div>
              <div>
                <span class="font-medium text-gray-700">Special Instructions:</span>
                <p id="previewSpecialInstructions" class="text-gray-600">-</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ORDER DETAILS VIEW (Dynamic) -->
  <div id="orderDetails" class="view">
    <div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-50 p-4 md:p-8">
      <div class="mx-auto max-w-4xl space-y-6" id="orderDetailsContent">
        <!-- Dynamic order details will be injected here -->
      </div>
      <div class="mx-auto max-w-4xl p-4">
        <button onclick="refreshOrders(); showView('dashboard')" class="rounded-lg bg-blue-600 px-4 py-2 text-white">Back to Dashboard</button>
      </div>
    </div>
  </div>

  <!-- ADMIN DASHBOARD VIEW -->
  <div id="adminDashboard" class="view">
    <div class="min-h-screen bg-gray-50">
      <div class="mb-6 bg-white p-4 shadow-sm">
        <div class="mx-auto max-w-7xl">
          <h1 class="text-2xl font-bold text-gray-800">Admin Dashboard</h1>
        </div>
      </div>
      <div class="mx-auto max-w-7xl p-4">
        <div class="mb-6 flex flex-wrap gap-2">
          <button id="adminTabOrders" onclick="setAdminTab('orders')" class="rounded-lg px-4 py-2 bg-blue-600 text-white">Orders</button>
          <button id="adminTabUsers" onclick="setAdminTab('users')" class="rounded-lg px-4 py-2 bg-white text-gray-700 hover:bg-gray-50">Users</button>
          <button id="adminTabSystem" onclick="setAdminTab('system')" class="rounded-lg px-4 py-2 bg-white text-gray-700 hover:bg-gray-50">System Status</button>
        </div>
        <div id="adminContent">
          <div id="adminOrders">
            <div id="adminOrdersContainer" class="overflow-x-auto rounded-lg bg-white p-4 shadow-sm">
              <div class="text-center text-gray-500">No orders yet</div>
            </div>
          </div>
          <div id="adminUsers" style="display:none;">
            <div class="overflow-x-auto rounded-lg bg-white p-4 shadow-sm">
              <table class="w-full">
                <thead>
                  <tr class="border-b">
                    <th class="pb-3 text-left">Name</th>
                    <th class="pb-3 text-left">Email</th>
                    <th class="pb-3 text-left">Role</th>
                    <th class="pb-3 text-left">Last Login</th>
                  </tr>
                </thead>
                <tbody>
                  <tr class="border-b">
                    <td class="py-3">John Doe</td>
                    <td class="py-3">john@example.com</td>
                    <td class="py-3">Customer</td>
                    <td class="py-3">1/15/2025</td>
                  </tr>
                  <tr class="border-b">
                    <td class="py-3">Jane Smith</td>
                    <td class="py-3">jane@example.com</td>
                    <td class="py-3">Admin</td>
                    <td class="py-3">1/14/2025</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          <div id="adminSystem" style="display:none;">
            <div class="grid gap-4 md:grid-cols-3">
              <div class="rounded-lg bg-white p-4 shadow-sm">
                <h3 class="mb-4 text-lg font-semibold">ERP Status</h3>
                <div class="space-y-2">
                  <div class="flex justify-between">
                    <span>Status:</span>
                    <span class="text-green-500">Connected</span>
                  </div>
                  <div class="flex justify-between">
                    <span>Last Sync:</span>
                    <span>15 minutes ago</span>
                  </div>
                </div>
              </div>
              <div class="rounded-lg bg-white p-4 shadow-sm">
                <h3 class="mb-4 text-lg font-semibold">Inventory System</h3>
                <div class="space-y-2">
                  <div class="flex justify-between">
                    <span>Status:</span>
                    <span class="text-green-500">Active</span>
                  </div>
                  <div class="flex justify-between">
                    <span>Last Update:</span>
                    <span>5 minutes ago</span>
                  </div>
                </div>
              </div>
              <div class="rounded-lg bg-white p-4 shadow-sm">
                <h3 class="mb-4 text-lg font-semibold">Shipping Integration</h3>
                <div class="space-y-2">
                  <div class="flex justify-between">
                    <span>Status:</span>
                    <span class="text-green-500">Active</span>
                  </div>
                  <div class="flex justify-between">
                    <span>Last Update:</span>
                    <span>2 minutes ago</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- DB OPS VIEW (Admin only) -->
  <div id="dbOps" class="view">
    <div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-50 p-6">
      <div class="mx-auto max-w-4xl">
        <h1 class="text-3xl font-bold text-gray-800 mb-4">Database Operations</h1>
        <p class="mb-4 text-gray-600">Execute SQL queries on the in-browser database based on our simplified schema.</p>
        <div class="mb-4">
          <textarea id="sqlQuery" class="w-full p-4 border rounded-lg" rows="4" placeholder="Enter your SQL query here"></textarea>
        </div>
        <div class="mb-4">
          <button onclick="runQuery()" class="rounded-lg bg-blue-600 px-4 py-2 text-white mr-2">Run Query</button>
          <button onclick="resetDatabase()" class="rounded-lg bg-red-600 px-4 py-2 text-white">Reset Database</button>
        </div>
        <pre id="queryResult" class="bg-white p-4 rounded-lg shadow-xl overflow-auto" style="max-height: 300px;"></pre>
      </div>
    </div>
  </div>

  <!-- JavaScript for Dynamic Order Management and Role-Based Behavior -->
  <script>
    let currentUser = null;
    let currentOrderData = null; // Data for currently viewed order
    let currentOrderStatus = "pending"; // For order details view
    window.dbInitialized = false;

    // Helper: Map email to a sample user ID
    function getUserId(email) {
      email = email.toLowerCase();
      if(email === "customer1@example.com") return 1;
      else if(email === "admin@example.com") return 2;
      else if(email === "factory@example.com") return 3;
      else return 1;
    }

    // Initialize the in-browser SQLite database
    function initDatabase() {
      if(window.dbInitialized) return Promise.resolve();
      return initSqlJs({ locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}` }).then(function(SQL) {
        window.SQL = SQL;
        window.db = new SQL.Database();
        const schema = `
          CREATE TABLE users (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            email TEXT NOT NULL UNIQUE,
            role TEXT CHECK( role IN ('customer','admin','factory_staff') ) NOT NULL,
            name TEXT NOT NULL,
            created_at TEXT DEFAULT CURRENT_TIMESTAMP
          );
          CREATE TABLE orders (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            status TEXT CHECK( status IN ('pending','processing','approved','manufacturing','quality_check','shipped','delivered','cancelled') ),
            notes TEXT,
            customer_id INTEGER,
            created_at TEXT DEFAULT CURRENT_TIMESTAMP
          );
        `;
        window.db.run(schema);
        // Insert sample data
        const insertData = `
          INSERT INTO users (email, role, name) VALUES 
            ('customer1@example.com','customer','Customer One'),
            ('admin@example.com','admin','Admin User'),
            ('factory@example.com','factory_staff','Factory Staff');
          INSERT INTO orders (status, notes, customer_id) VALUES 
            ('pending', 'Order placed', 1),
            ('processing', 'Order is being processed', 1),
            ('approved', 'Order approved', 1),
            ('manufacturing', 'Order in manufacturing', 1),
            ('delivered', 'Order delivered', 1);
        `;
        window.db.run(insertData);
        window.dbInitialized = true;
      });
    }

    // Show a given view and update relevant panels based on the user's role.
    function showView(viewId) {
      // Restrict DB Ops view to admins only
      if(viewId === "dbOps" && currentUser && currentUser.role !== "admin") {
        alert("Access Denied: This view is for admins only.");
        return;
      }
      document.querySelectorAll('.view').forEach(section => section.style.display = 'none');
      document.getElementById(viewId).style.display = 'block';
      if(viewId === 'dashboard' && currentUser) {
        document.getElementById('userEmailDisplay').innerText = currentUser.email;
        document.getElementById('userRoleDisplay').innerText = currentUser.role;
        // Show different dashboard panels based on role.
        if(currentUser.role === 'admin') {
          document.getElementById('adminDashboardContent').style.display = 'block';
          document.getElementById('customerDashboard').style.display = 'none';
          document.getElementById('factoryDashboard').style.display = 'none';
          updateAdminOrders();
          // Show admin-only nav links
          document.getElementById('adminLink').style.display = 'inline';
          document.getElementById('dbOpsLink').style.display = 'inline';
        } else if(currentUser.role === "factory") {
          document.getElementById('adminDashboardContent').style.display = 'none';
          document.getElementById('customerDashboard').style.display = 'none';
          document.getElementById('factoryDashboard').style.display = 'block';
          updateFactoryOrders();
          // Hide admin-only nav links
          document.getElementById('adminLink').style.display = 'none';
          document.getElementById('dbOpsLink').style.display = 'none';
        } else {
          document.getElementById('adminDashboardContent').style.display = 'none';
          document.getElementById('factoryDashboard').style.display = 'none';
          document.getElementById('customerDashboard').style.display = 'block';
          updateMyOrders();
          // Hide admin-only nav links
          document.getElementById('adminLink').style.display = 'none';
          document.getElementById('dbOpsLink').style.display = 'none';
        }
        initDatabase().then(() => {
          updateDashboardAnalytics();
        });
      }
      if(viewId === 'aiInsights') { initAIChart(); }
      if(viewId === 'dbOps') { initDatabase(); }
    }

    // Update navigation based on authentication state.
    function updateNav() {
      if (currentUser) {
        document.getElementById('navLogin').style.display = 'none';
        document.getElementById('navSignup').style.display = 'none';
        document.getElementById('navLogout').style.display = 'inline';
      } else {
        document.getElementById('navLogin').style.display = 'inline';
        document.getElementById('navSignup').style.display = 'inline';
        document.getElementById('navLogout').style.display = 'none';
      }
    }

    // Login handler.
    document.getElementById('loginForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const email = document.getElementById('loginEmail').value.trim();
      const password = document.getElementById('loginPassword').value.trim();
      if (!email || !password) {
        document.getElementById('loginError').innerText = "Please fill in all fields";
        return;
      }
      currentUser = {
        email: email,
        role: (email.toLowerCase() === "admin@example.com") ? "admin" :
              (email.toLowerCase() === "factory@example.com") ? "factory" : "customer"
      };
      updateNav();
      showView('dashboard');
    });

    // Signup handler.
    document.getElementById('signupForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const email = document.getElementById('signupEmail').value.trim();
      const password = document.getElementById('signupPassword').value.trim();
      if (!email || !password) {
        document.getElementById('signupError').innerText = "Please fill in all fields";
        return;
      }
      currentUser = { email: email, role: "customer" };
      updateNav();
      showView('dashboard');
    });

    // Logout handler.
    function logout() {
      currentUser = null;
      updateNav();
      showView('login');
    }

    // New Order form preview update.
    document.getElementById('newOrderForm').addEventListener('input', function() {
      document.getElementById('previewCustomerName').innerText = document.querySelector('input[name="customerName"]').value || "-";
      document.getElementById('previewEmail').innerText = document.querySelector('input[name="email"]').value || "-";
      document.getElementById('previewProductName').innerText = document.querySelector('input[name="productName"]').value || "-";
      document.getElementById('previewQuantity').innerText = document.querySelector('input[name="quantity"]').value || "1";
      document.getElementById('previewSpecialInstructions').innerText = document.querySelector('textarea[name="specialInstructions"]').value || "-";
    });

    // New Order submission: Insert new order into DB and update dashboard.
    document.getElementById('newOrderForm').addEventListener('submit', function(e) {
      e.preventDefault();
      initDatabase().then(() => {
        const email = document.querySelector('input[name="email"]').value;
        const customerId = getUserId(email);
        const productName = document.querySelector('input[name="productName"]').value;
        const specialInstructions = document.querySelector('textarea[name="specialInstructions"]').value;
        // New orders always start with status "pending"
        const sql = `INSERT INTO orders (status, notes, customer_id) VALUES ('pending', '${productName} - ${specialInstructions}', ${customerId});`;
        window.db.run(sql);
        alert("Order submitted!");
        showView('dashboard');
      });
    });

    // Update order status for order details view.
    function updateOrderStatus() {
      const newStatus = document.getElementById('orderNewStatus').value;
      if (!newStatus) return;
      
      if(currentUser.role === "factory") {
        alert("Factory staff cannot update order status. Please use the 'Add Suggestion' option.");
        return;
      }
      
      if(currentUser.role === "customer" && ["approved", "manufacturing", "quality_check", "shipped", "delivered"].includes(currentOrderStatus)) {
        alert("Your order is already in production and cannot be updated or cancelled.");
        return;
      }
      
      // Update the order status in the database.
      window.db.run("UPDATE orders SET status = '" + newStatus + "' WHERE id = " + currentOrderData[0] + ";");
      currentOrderStatus = newStatus;
      document.getElementById('orderStatusDisplay').innerText = newStatus.charAt(0).toUpperCase() + newStatus.slice(1);
      
      const now = new Date().toLocaleString();
      const newHistoryHtml = `
        <div class="rounded-lg border border-gray-100 bg-gray-50 p-4">
          <div class="mb-2 flex items-center justify-between">
            <span class="font-medium">${newStatus.charAt(0).toUpperCase() + newStatus.slice(1)}</span>
            <span class="text-sm text-gray-600">${now}</span>
          </div>
          <p class="text-gray-700">Order status updated to ${newStatus}.</p>
        </div>`;
      document.getElementById('orderHistory').insertAdjacentHTML('beforeend', newHistoryHtml);
      
      updateOrderControls();
      updateFeedbackVisibility();
      updateDashboardAnalytics();
      if(currentUser.role === "customer") updateMyOrders();
      else if(currentUser.role === "admin") updateAdminOrders();
      else if(currentUser.role === "factory") updateFactoryOrders();
    }

    // Cancel order for customers.
    function cancelOrder() {
      if(currentUser.role === "customer" && ["approved", "manufacturing", "quality_check", "shipped", "delivered"].includes(currentOrderStatus)) {
        alert("Order cannot be cancelled at this stage.");
        return;
      }
      window.db.run("UPDATE orders SET status = 'cancelled' WHERE id = " + currentOrderData[0] + ";");
      currentOrderStatus = "cancelled";
      document.getElementById('orderStatusDisplay').innerText = "Cancelled";
      const now = new Date().toLocaleString();
      const newHistoryHtml = `
        <div class="rounded-lg border border-gray-100 bg-gray-50 p-4">
          <div class="mb-2 flex items-center justify-between">
            <span class="font-medium">Cancelled</span>
            <span class="text-sm text-gray-600">${now}</span>
          </div>
          <p class="text-gray-700">Order has been cancelled.</p>
        </div>`;
      document.getElementById('orderHistory').insertAdjacentHTML('beforeend', newHistoryHtml);
      document.getElementById('orderUpdateControls').style.display = "none";
      updateFeedbackVisibility();
      updateDashboardAnalytics();
      if(currentUser.role === "customer") updateMyOrders();
      else if(currentUser.role === "admin") updateAdminOrders();
      else if(currentUser.role === "factory") updateFactoryOrders();
    }

    // For factory staff: Add suggestion (their only allowed update)
    function addSuggestion() {
      const suggestion = prompt("Enter your suggestion or note for this order:");
      if(suggestion) {
        const now = new Date().toLocaleString();
        const newHistoryHtml = `
          <div class="rounded-lg border border-gray-100 bg-gray-50 p-4">
            <div class="mb-2 flex items-center justify-between">
              <span class="font-medium">Suggestion (Factory)</span>
              <span class="text-sm text-gray-600">${now}</span>
            </div>
            <p class="text-gray-700">${suggestion}</p>
          </div>`;
        document.getElementById('orderHistory').insertAdjacentHTML('beforeend', newHistoryHtml);
        // In a real system, suggestions would be stored in the DB (perhaps in a separate table).
      }
    }

    // Update visibility of order update controls based on role and status.
    function updateOrderControls() {
      const controls = document.getElementById('orderUpdateControls');
      // For customers: allow update if status is pending or processing.
      if(currentUser.role === "customer") {
        if(["pending", "processing"].includes(currentOrderStatus)) {
          controls.style.display = "block";
        } else {
          controls.style.display = "none";
        }
      }
      // For factory staff: hide update/cancel buttons and show "Add Suggestion" button.
      else if(currentUser.role === "factory") {
        controls.style.display = "none";
        // Append an "Add Suggestion" button if not already present.
        if(!document.getElementById('suggestionBtn')) {
          const suggestionBtn = document.createElement('button');
          suggestionBtn.id = "suggestionBtn";
          suggestionBtn.className = "rounded-lg bg-purple-600 px-4 py-2 text-white mt-4";
          suggestionBtn.innerText = "Add Suggestion";
          suggestionBtn.onclick = addSuggestion;
          document.getElementById('orderDetailsContent').appendChild(suggestionBtn);
        }
      }
      // Admins always see update controls.
      else {
        controls.style.display = "block";
      }
    }

    // Show feedback button only if order is delivered and user is a customer.
    function updateFeedbackVisibility() {
      const feedbackSection = document.getElementById('feedbackSection');
      if(currentOrderStatus === "delivered" && currentUser.role === "customer") {
        feedbackSection.style.display = "block";
      } else {
        feedbackSection.style.display = "none";
      }
    }

    // Submit feedback handler.
    function submitFeedback() {
      const feedback = prompt("Please enter your feedback for this order:");
      if(feedback) {
        alert("Thank you for your feedback!");
      }
    }

    // Admin dashboard tab switching.
    function setAdminTab(tab) {
      document.getElementById('adminOrders').style.display = (tab === 'orders') ? 'block' : 'none';
      document.getElementById('adminUsers').style.display = (tab === 'users') ? 'block' : 'none';
      document.getElementById('adminSystem').style.display = (tab === 'system') ? 'block' : 'none';
    }

    // Initialize AI Insights chart.
    function initAIChart() {
      const ctx = document.getElementById('aiChart').getContext('2d');
      if (window.aiChartInstance) { window.aiChartInstance.destroy(); }
      window.aiChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May'],
          datasets: [{
            label: 'Predicted Orders',
            data: [30, 45, 28, 60, 55],
            backgroundColor: 'rgba(54, 162, 235, 0.6)'
          }]
        },
        options: { responsive: true, maintainAspectRatio: false }
      });
    }

    // Update dashboard analytics by querying the orders table.
    function updateDashboardAnalytics() {
      if(!window.dbInitialized) return;
      let result = window.db.exec("SELECT status, COUNT(*) as count FROM orders GROUP BY status;");
      let counts = { pending: 0, processing: 0, approved: 0, manufacturing: 0, quality_check: 0, shipped: 0, delivered: 0, cancelled: 0 };
      if(result.length > 0) {
        result[0].values.forEach(row => { counts[row[0]] = row[1]; });
      }
      let totalOrders = Object.values(counts).reduce((a, b) => a + b, 0);
      document.getElementById("totalOrders").innerText = totalOrders;
      document.getElementById("pendingOrders").innerText = counts.pending;
      document.getElementById("processingOrders").innerText = counts.processing;
      document.getElementById("manufacturingOrders").innerText = counts.approved + counts.manufacturing + counts.quality_check;
      document.getElementById("completedOrders").innerText = counts.delivered;
      document.getElementById("cancelledOrders").innerText = counts.cancelled;
      
      const pieData = [
        counts.pending,
        counts.processing,
        counts.approved + counts.manufacturing + counts.quality_check,
        counts.delivered,
        counts.cancelled
      ];
      const ctx = document.getElementById("dashboardPieChart").getContext("2d");
      if(window.dashboardPieChartInstance) { window.dashboardPieChartInstance.destroy(); }
      window.dashboardPieChartInstance = new Chart(ctx, {
        type: "pie",
        data: {
          labels: ["Pending", "Processing", "Manufacturing", "Delivered", "Cancelled"],
          datasets: [{ data: pieData, backgroundColor: [
              "rgba(255, 99, 132, 0.6)",
              "rgba(54, 162, 235, 0.6)",
              "rgba(255, 159, 64, 0.6)",
              "rgba(75, 192, 192, 0.6)",
              "rgba(255, 206, 86, 0.6)"
            ] }]
        },
        options: { responsive: true, maintainAspectRatio: false }
      });
    }

    // Update "My Orders" panel for customers.
    function updateMyOrders() {
      if(!window.dbInitialized || !currentUser) return;
      let userId = getUserId(currentUser.email);
      let result = window.db.exec("SELECT * FROM orders WHERE customer_id = " + userId + " ORDER BY created_at DESC;");
      const container = document.getElementById("customerOrdersContainer");
      if(result.length > 0 && result[0].values.length > 0) {
        container.innerHTML = "";
        result[0].values.forEach(row => {
          const orderHtml = `
            <div class="order-card rounded-lg bg-white p-4 shadow-lg mb-4" onclick="showOrderDetails(${row[0]})">
              <p><strong>Order #</strong> ${row[0]}</p>
              <p><strong>Status:</strong> ${row[1]}</p>
              <p><strong>Date:</strong> ${row[4]}</p>
            </div>
          `;
          container.innerHTML += orderHtml;
        });
      } else {
        container.innerHTML = `<div class="text-center text-gray-500">No orders yet</div>`;
      }
    }

    // Update orders panel for factory staff.
    function updateFactoryOrders() {
      if(!window.dbInitialized) return;
      // For factory staff, show orders that are not pending or cancelled.
      let result = window.db.exec("SELECT * FROM orders WHERE status NOT IN ('pending','cancelled') ORDER BY created_at DESC;");
      const container = document.getElementById("factoryOrdersContainer");
      if(result.length > 0 && result[0].values.length > 0) {
        container.innerHTML = "";
        result[0].values.forEach(row => {
          const orderHtml = `
            <div class="order-card rounded-lg bg-white p-4 shadow-lg mb-4" onclick="showOrderDetails(${row[0]})">
              <p><strong>Order #</strong> ${row[0]}</p>
              <p><strong>Status:</strong> ${row[1]}</p>
              <p><strong>Date:</strong> ${row[4]}</p>
            </div>
          `;
          container.innerHTML += orderHtml;
        });
      } else {
        container.innerHTML = `<div class="text-center text-gray-500">No orders available</div>`;
      }
    }

    // Update orders panel for admin users.
    function updateAdminOrders() {
      if(!window.dbInitialized) return;
      let result = window.db.exec("SELECT o.id, u.name, o.status, o.created_at FROM orders o JOIN users u ON o.customer_id = u.id ORDER BY o.created_at DESC;");
      const container = document.getElementById("adminOrdersContainer");
      if(result.length > 0 && result[0].values.length > 0) {
        container.innerHTML = "";
        result[0].values.forEach(row => {
          const orderHtml = `
            <div class="order-card rounded-lg bg-white p-4 shadow-lg mb-4" onclick="showOrderDetails(${row[0]})">
              <p><strong>Order #</strong> ${row[0]}</p>
              <p><strong>Customer:</strong> ${row[1]}</p>
              <p><strong>Status:</strong> ${row[2]}</p>
              <p><strong>Date:</strong> ${row[3]}</p>
            </div>
          `;
          container.innerHTML += orderHtml;
        });
      } else {
        container.innerHTML = `<div class="text-center text-gray-500">No orders yet</div>`;
      }
    }

    // Dynamically load order details based on the clicked order.
    function showOrderDetails(orderId) {
      if(!window.dbInitialized) return;
      let result = window.db.exec("SELECT * FROM orders WHERE id = " + orderId + ";");
      if(result.length === 0 || result[0].values.length === 0) {
        alert("Order not found.");
        return;
      }
      currentOrderData = result[0].values[0]; // [id, status, notes, customer_id, created_at]
      currentOrderStatus = currentOrderData[1];
      let detailsHtml = `
        <div class="rounded-2xl bg-white p-6 shadow-xl">
          <div class="mb-6 flex flex-wrap items-center justify-between gap-4">
            <h1 class="text-2xl font-bold text-gray-800">Order ORD-${currentOrderData[0]}</h1>
            <div id="orderStatusDisplay" class="rounded-full bg-blue-100 px-4 py-2 text-blue-800">${currentOrderData[1].charAt(0).toUpperCase() + currentOrderData[1].slice(1)}</div>
          </div>
          <div id="orderHistory">
            <div class="rounded-lg border border-gray-100 bg-gray-50 p-4 mb-2">
              <div class="mb-2 flex items-center justify-between">
                <span class="font-medium">Order Placed</span>
                <span class="text-sm text-gray-600">${currentOrderData[4]}</span>
              </div>
              <p class="text-gray-700">${currentOrderData[2]}</p>
            </div>
          </div>`;
      // For customers and admins, show update/cancel controls if allowed.
      if(currentUser.role === "customer" || currentUser.role === "admin") {
        detailsHtml += `
          <div id="orderUpdateControls" class="mt-4">
            <div id="statusUpdateSection" class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-1">Update Order Status</label>
              <div class="flex gap-4">
                <select id="orderNewStatus" class="flex-1 rounded-lg border border-gray-200 p-2">
                  <option value="">Select new status</option>
                  <option value="pending">Pending</option>
                  <option value="processing">Processing</option>
                  <option value="approved">Approved</option>
                  <option value="manufacturing">Manufacturing</option>
                  <option value="quality_check">Quality Check</option>
                  <option value="shipped">Shipped</option>
                  <option value="delivered">Delivered</option>
                  <option value="cancelled">Cancelled</option>
                </select>
                <button onclick="updateOrderStatus()" class="rounded-lg bg-blue-600 px-4 py-2 text-white">Update</button>
              </div>
            </div>
            <div id="cancelOrderSection" class="mb-4">
              <button onclick="cancelOrder()" class="rounded-lg bg-red-600 px-4 py-2 text-white">Cancel Order</button>
            </div>
          </div>`;
      }
      // For factory staff, hide update controls and show "Add Suggestion" button.
      if(currentUser.role === "factory") {
        detailsHtml += `
          <div id="factorySuggestionSection" class="mt-4">
            <button id="suggestionBtn" onclick="addSuggestion()" class="rounded-lg bg-purple-600 px-4 py-2 text-white">Add Suggestion</button>
          </div>`;
      }
      // Feedback button for customers if order is delivered.
      detailsHtml += `
          <div id="feedbackSection" style="display:none;" class="mt-4">
            <button onclick="submitFeedback()" class="rounded-lg bg-green-600 px-4 py-2 text-white">Give Feedback</button>
          </div>
        </div>`;
      document.getElementById('orderDetailsContent').innerHTML = detailsHtml;
      updateOrderControls();
      updateFeedbackVisibility();
      showView('orderDetails');
    }

    // Factory staff: Add suggestion (their only permitted update).
    function addSuggestion() {
      const suggestion = prompt("Enter your suggestion for this order:");
      if(suggestion) {
        const now = new Date().toLocaleString();
        const newHistoryHtml = `
          <div class="rounded-lg border border-gray-100 bg-gray-50 p-4">
            <div class="mb-2 flex items-center justify-between">
              <span class="font-medium">Suggestion (Factory)</span>
              <span class="text-sm text-gray-600">${now}</span>
            </div>
            <p class="text-gray-700">${suggestion}</p>
          </div>`;
        document.getElementById('orderHistory').insertAdjacentHTML('beforeend', newHistoryHtml);
      }
    }

    // Update visibility of order update controls based on role and current order status.
    function updateOrderControls() {
      const controls = document.getElementById('orderUpdateControls');
      if(currentUser.role === "customer") {
        if(["pending", "processing"].includes(currentOrderStatus)) {
          controls.style.display = "block";
        } else {
          controls.style.display = "none";
        }
      } else if(currentUser.role === "factory") {
        // Factory staff do not see update/cancel controls.
        if(controls) controls.style.display = "none";
      } else {
        // Admins always see update controls.
        controls.style.display = "block";
      }
    }

    // Show feedback button only if order is delivered and user is a customer.
    function updateFeedbackVisibility() {
      const feedbackSection = document.getElementById('feedbackSection');
      if(currentOrderStatus === "delivered" && currentUser.role === "customer") {
        feedbackSection.style.display = "block";
      } else {
        feedbackSection.style.display = "none";
      }
    }

    // Submit feedback.
    function submitFeedback() {
      const feedback = prompt("Please enter your feedback for this order:");
      if(feedback) {
        alert("Thank you for your feedback!");
      }
    }

    // Admin dashboard tab switching.
    function setAdminTab(tab) {
      document.getElementById('adminOrders').style.display = (tab === 'orders') ? 'block' : 'none';
      document.getElementById('adminUsers').style.display = (tab === 'users') ? 'block' : 'none';
      document.getElementById('adminSystem').style.display = (tab === 'system') ? 'block' : 'none';
    }

    // Initialize AI Insights chart.
    function initAIChart() {
      const ctx = document.getElementById('aiChart').getContext('2d');
      if (window.aiChartInstance) { window.aiChartInstance.destroy(); }
      window.aiChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May'],
          datasets: [{
            label: 'Predicted Orders',
            data: [30, 45, 28, 60, 55],
            backgroundColor: 'rgba(54, 162, 235, 0.6)'
          }]
        },
        options: { responsive: true, maintainAspectRatio: false }
      });
    }

    // Update dashboard analytics by querying the orders table.
    function updateDashboardAnalytics() {
      if(!window.dbInitialized) return;
      let result = window.db.exec("SELECT status, COUNT(*) as count FROM orders GROUP BY status;");
      let counts = { pending: 0, processing: 0, approved: 0, manufacturing: 0, quality_check: 0, shipped: 0, delivered: 0, cancelled: 0 };
      if(result.length > 0) {
        result[0].values.forEach(row => { counts[row[0]] = row[1]; });
      }
      let totalOrders = Object.values(counts).reduce((a, b) => a + b, 0);
      document.getElementById("totalOrders").innerText = totalOrders;
      document.getElementById("pendingOrders").innerText = counts.pending;
      document.getElementById("processingOrders").innerText = counts.processing;
      document.getElementById("manufacturingOrders").innerText = counts.approved + counts.manufacturing + counts.quality_check;
      document.getElementById("completedOrders").innerText = counts.delivered;
      document.getElementById("cancelledOrders").innerText = counts.cancelled;
      
      const pieData = [
        counts.pending,
        counts.processing,
        counts.approved + counts.manufacturing + counts.quality_check,
        counts.delivered,
        counts.cancelled
      ];
      const ctx = document.getElementById("dashboardPieChart").getContext("2d");
      if(window.dashboardPieChartInstance) { window.dashboardPieChartInstance.destroy(); }
      window.dashboardPieChartInstance = new Chart(ctx, {
        type: "pie",
        data: {
          labels: ["Pending", "Processing", "Manufacturing", "Delivered", "Cancelled"],
          datasets: [{ data: pieData, backgroundColor: [
              "rgba(255, 99, 132, 0.6)",
              "rgba(54, 162, 235, 0.6)",
              "rgba(255, 159, 64, 0.6)",
              "rgba(75, 192, 192, 0.6)",
              "rgba(255, 206, 86, 0.6)"
            ] }]
        },
        options: { responsive: true, maintainAspectRatio: false }
      });
    }

    // Update "My Orders" panel for customers.
    function updateMyOrders() {
      if(!window.dbInitialized || !currentUser) return;
      let userId = getUserId(currentUser.email);
      let result = window.db.exec("SELECT * FROM orders WHERE customer_id = " + userId + " ORDER BY created_at DESC;");
      const container = document.getElementById("customerOrdersContainer");
      if(result.length > 0 && result[0].values.length > 0) {
        container.innerHTML = "";
        result[0].values.forEach(row => {
          const orderHtml = `
            <div class="order-card rounded-lg bg-white p-4 shadow-lg mb-4" onclick="showOrderDetails(${row[0]})">
              <p><strong>Order #</strong> ${row[0]}</p>
              <p><strong>Status:</strong> ${row[1]}</p>
              <p><strong>Date:</strong> ${row[4]}</p>
            </div>
          `;
          container.innerHTML += orderHtml;
        });
      } else {
        container.innerHTML = `<div class="text-center text-gray-500">No orders yet</div>`;
      }
    }

    // Update orders panel for factory staff.
    function updateFactoryOrders() {
      if(!window.dbInitialized) return;
      // Show orders that are not pending or cancelled.
      let result = window.db.exec("SELECT * FROM orders WHERE status NOT IN ('pending','cancelled') ORDER BY created_at DESC;");
      const container = document.getElementById("factoryOrdersContainer");
      if(result.length > 0 && result[0].values.length > 0) {
        container.innerHTML = "";
        result[0].values.forEach(row => {
          const orderHtml = `
            <div class="order-card rounded-lg bg-white p-4 shadow-lg mb-4" onclick="showOrderDetails(${row[0]})">
              <p><strong>Order #</strong> ${row[0]}</p>
              <p><strong>Status:</strong> ${row[1]}</p>
              <p><strong>Date:</strong> ${row[4]}</p>
            </div>
          `;
          container.innerHTML += orderHtml;
        });
      } else {
        container.innerHTML = `<div class="text-center text-gray-500">No orders available</div>`;
      }
    }

    // Update orders panel for admin users.
    function updateAdminOrders() {
      if(!window.dbInitialized) return;
      let result = window.db.exec("SELECT o.id, u.name, o.status, o.created_at FROM orders o JOIN users u ON o.customer_id = u.id ORDER BY o.created_at DESC;");
      const container = document.getElementById("adminOrdersContainer");
      if(result.length > 0 && result[0].values.length > 0) {
        container.innerHTML = "";
        result[0].values.forEach(row => {
          const orderHtml = `
            <div class="order-card rounded-lg bg-white p-4 shadow-lg mb-4" onclick="showOrderDetails(${row[0]})">
              <p><strong>Order #</strong> ${row[0]}</p>
              <p><strong>Customer:</strong> ${row[1]}</p>
              <p><strong>Status:</strong> ${row[2]}</p>
              <p><strong>Date:</strong> ${row[3]}</p>
            </div>
          `;
          container.innerHTML += orderHtml;
        });
      } else {
        container.innerHTML = `<div class="text-center text-gray-500">No orders yet</div>`;
      }
    }

    // Dynamically load order details for a selected order.
    function showOrderDetails(orderId) {
      if(!window.dbInitialized) return;
      let result = window.db.exec("SELECT * FROM orders WHERE id = " + orderId + ";");
      if(result.length === 0 || result[0].values.length === 0) {
        alert("Order not found.");
        return;
      }
      currentOrderData = result[0].values[0]; // [id, status, notes, customer_id, created_at]
      currentOrderStatus = currentOrderData[1];
      let detailsHtml = `
        <div class="rounded-2xl bg-white p-6 shadow-xl">
          <div class="mb-6 flex flex-wrap items-center justify-between gap-4">
            <h1 class="text-2xl font-bold text-gray-800">Order ORD-${currentOrderData[0]}</h1>
            <div id="orderStatusDisplay" class="rounded-full bg-blue-100 px-4 py-2 text-blue-800">${currentOrderData[1].charAt(0).toUpperCase() + currentOrderData[1].slice(1)}</div>
          </div>
          <div id="orderHistory">
            <div class="rounded-lg border border-gray-100 bg-gray-50 p-4 mb-2">
              <div class="mb-2 flex items-center justify-between">
                <span class="font-medium">Order Placed</span>
                <span class="text-sm text-gray-600">${currentOrderData[4]}</span>
              </div>
              <p class="text-gray-700">${currentOrderData[2]}</p>
            </div>
          </div>`;
      // For customers and admins, show update/cancel controls if order is in allowed stages.
      if(currentUser.role === "customer" || currentUser.role === "admin") {
        detailsHtml += `
          <div id="orderUpdateControls" class="mt-4">
            <div id="statusUpdateSection" class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-1">Update Order Status</label>
              <div class="flex gap-4">
                <select id="orderNewStatus" class="flex-1 rounded-lg border border-gray-200 p-2">
                  <option value="">Select new status</option>
                  <option value="pending">Pending</option>
                  <option value="processing">Processing</option>
                  <option value="approved">Approved</option>
                  <option value="manufacturing">Manufacturing</option>
                  <option value="quality_check">Quality Check</option>
                  <option value="shipped">Shipped</option>
                  <option value="delivered">Delivered</option>
                  <option value="cancelled">Cancelled</option>
                </select>
                <button onclick="updateOrderStatus()" class="rounded-lg bg-blue-600 px-4 py-2 text-white">Update</button>
              </div>
            </div>
            <div id="cancelOrderSection" class="mb-4">
              <button onclick="cancelOrder()" class="rounded-lg bg-red-600 px-4 py-2 text-white">Cancel Order</button>
            </div>
          </div>`;
      }
      // For factory staff, hide update/cancel controls and show "Add Suggestion" button.
      if(currentUser.role === "factory") {
        detailsHtml += `
          <div id="factorySuggestionSection" class="mt-4">
            <button id="suggestionBtn" onclick="addSuggestion()" class="rounded-lg bg-purple-600 px-4 py-2 text-white">Add Suggestion</button>
          </div>`;
      }
      // Feedback option for customers if order is delivered.
      detailsHtml += `
          <div id="feedbackSection" style="display:none;" class="mt-4">
            <button onclick="submitFeedback()" class="rounded-lg bg-green-600 px-4 py-2 text-white">Give Feedback</button>
          </div>
        </div>`;
      document.getElementById('orderDetailsContent').innerHTML = detailsHtml;
      updateOrderControls();
      updateFeedbackVisibility();
      showView('orderDetails');
    }

    // Factory staff: Add suggestion.
    function addSuggestion() {
      const suggestion = prompt("Enter your suggestion for this order:");
      if(suggestion) {
        const now = new Date().toLocaleString();
        const newHistoryHtml = `
          <div class="rounded-lg border border-gray-100 bg-gray-50 p-4">
            <div class="mb-2 flex items-center justify-between">
              <span class="font-medium">Suggestion (Factory)</span>
              <span class="text-sm text-gray-600">${now}</span>
            </div>
            <p class="text-gray-700">${suggestion}</p>
          </div>`;
        document.getElementById('orderHistory').insertAdjacentHTML('beforeend', newHistoryHtml);
      }
    }

    // Update order update controls based on role and order status.
    function updateOrderControls() {
      const controls = document.getElementById('orderUpdateControls');
      if(currentUser.role === "customer") {
        if(["pending", "processing"].includes(currentOrderStatus)) {
          controls.style.display = "block";
        } else {
          controls.style.display = "none";
        }
      } else if(currentUser.role === "factory") {
        if(controls) controls.style.display = "none";
      } else {
        controls.style.display = "block";
      }
    }

    // Update feedback visibility.
    function updateFeedbackVisibility() {
      const feedbackSection = document.getElementById('feedbackSection');
      if(currentOrderStatus === "delivered" && currentUser.role === "customer") {
        feedbackSection.style.display = "block";
      } else {
        feedbackSection.style.display = "none";
      }
    }

    // Submit feedback handler.
    function submitFeedback() {
      const feedback = prompt("Please enter your feedback for this order:");
      if(feedback) {
        alert("Thank you for your feedback!");
      }
    }

    // Admin dashboard tab switching.
    function setAdminTab(tab) {
      document.getElementById('adminOrders').style.display = (tab === 'orders') ? 'block' : 'none';
      document.getElementById('adminUsers').style.display = (tab === 'users') ? 'block' : 'none';
      document.getElementById('adminSystem').style.display = (tab === 'system') ? 'block' : 'none';
    }

    // Initialize AI Insights chart.
    function initAIChart() {
      const ctx = document.getElementById('aiChart').getContext('2d');
      if (window.aiChartInstance) { window.aiChartInstance.destroy(); }
      window.aiChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May'],
          datasets: [{
            label: 'Predicted Orders',
            data: [30, 45, 28, 60, 55],
            backgroundColor: 'rgba(54, 162, 235, 0.6)'
          }]
        },
        options: { responsive: true, maintainAspectRatio: false }
      });
    }

    // Update dashboard analytics by querying orders.
    function updateDashboardAnalytics() {
      if(!window.dbInitialized) return;
      let result = window.db.exec("SELECT status, COUNT(*) as count FROM orders GROUP BY status;");
      let counts = { pending: 0, processing: 0, approved: 0, manufacturing: 0, quality_check: 0, shipped: 0, delivered: 0, cancelled: 0 };
      if(result.length > 0) {
        result[0].values.forEach(row => { counts[row[0]] = row[1]; });
      }
      let totalOrders = Object.values(counts).reduce((a, b) => a + b, 0);
      document.getElementById("totalOrders").innerText = totalOrders;
      document.getElementById("pendingOrders").innerText = counts.pending;
      document.getElementById("processingOrders").innerText = counts.processing;
      document.getElementById("manufacturingOrders").innerText = counts.approved + counts.manufacturing + counts.quality_check;
      document.getElementById("completedOrders").innerText = counts.delivered;
      document.getElementById("cancelledOrders").innerText = counts.cancelled;
      
      const pieData = [
        counts.pending,
        counts.processing,
        counts.approved + counts.manufacturing + counts.quality_check,
        counts.delivered,
        counts.cancelled
      ];
      const ctx = document.getElementById("dashboardPieChart").getContext("2d");
      if(window.dashboardPieChartInstance) { window.dashboardPieChartInstance.destroy(); }
      window.dashboardPieChartInstance = new Chart(ctx, {
        type: "pie",
        data: {
          labels: ["Pending", "Processing", "Manufacturing", "Delivered", "Cancelled"],
          datasets: [{ data: pieData, backgroundColor: [
              "rgba(255, 99, 132, 0.6)",
              "rgba(54, 162, 235, 0.6)",
              "rgba(255, 159, 64, 0.6)",
              "rgba(75, 192, 192, 0.6)",
              "rgba(255, 206, 86, 0.6)"
            ] }]
        },
        options: { responsive: true, maintainAspectRatio: false }
      });
    }

    // Update "My Orders" panel for customers.
    function updateMyOrders() {
      if(!window.dbInitialized || !currentUser) return;
      let userId = getUserId(currentUser.email);
      let result = window.db.exec("SELECT * FROM orders WHERE customer_id = " + userId + " ORDER BY created_at DESC;");
      const container = document.getElementById("customerOrdersContainer");
      if(result.length > 0 && result[0].values.length > 0) {
        container.innerHTML = "";
        result[0].values.forEach(row => {
          const orderHtml = `
            <div class="order-card rounded-lg bg-white p-4 shadow-lg mb-4" onclick="showOrderDetails(${row[0]})">
              <p><strong>Order #</strong> ${row[0]}</p>
              <p><strong>Status:</strong> ${row[1]}</p>
              <p><strong>Date:</strong> ${row[4]}</p>
            </div>
          `;
          container.innerHTML += orderHtml;
        });
      } else {
        container.innerHTML = `<div class="text-center text-gray-500">No orders yet</div>`;
      }
    }

    // Update orders panel for factory staff.
    function updateFactoryOrders() {
      if(!window.dbInitialized) return;
      // For factory staff, show orders that are in production (exclude pending and cancelled)
      let result = window.db.exec("SELECT * FROM orders WHERE status NOT IN ('pending','cancelled') ORDER BY created_at DESC;");
      const container = document.getElementById("factoryOrdersContainer");
      if(result.length > 0 && result[0].values.length > 0) {
        container.innerHTML = "";
        result[0].values.forEach(row => {
          const orderHtml = `
            <div class="order-card rounded-lg bg-white p-4 shadow-lg mb-4" onclick="showOrderDetails(${row[0]})">
              <p><strong>Order #</strong> ${row[0]}</p>
              <p><strong>Status:</strong> ${row[1]}</p>
              <p><strong>Date:</strong> ${row[4]}</p>
            </div>
          `;
          container.innerHTML += orderHtml;
        });
      } else {
        container.innerHTML = `<div class="text-center text-gray-500">No orders available</div>`;
      }
    }

    // Update orders panel for admin users.
    function updateAdminOrders() {
      if(!window.dbInitialized) return;
      let result = window.db.exec("SELECT o.id, u.name, o.status, o.created_at FROM orders o JOIN users u ON o.customer_id = u.id ORDER BY o.created_at DESC;");
      const container = document.getElementById("adminOrdersContainer");
      if(result.length > 0 && result[0].values.length > 0) {
        container.innerHTML = "";
        result[0].values.forEach(row => {
          const orderHtml = `
            <div class="order-card rounded-lg bg-white p-4 shadow-lg mb-4" onclick="showOrderDetails(${row[0]})">
              <p><strong>Order #</strong> ${row[0]}</p>
              <p><strong>Customer:</strong> ${row[1]}</p>
              <p><strong>Status:</strong> ${row[2]}</p>
              <p><strong>Date:</strong> ${row[3]}</p>
            </div>
          `;
          container.innerHTML += orderHtml;
        });
      } else {
        container.innerHTML = `<div class="text-center text-gray-500">No orders yet</div>`;
      }
    }

    // Refresh orders and analytics when returning to the dashboard.
    function refreshOrders() {
      if(currentUser.role === "admin") updateAdminOrders();
      else if(currentUser.role === "factory") updateFactoryOrders();
      else updateMyOrders();
      updateDashboardAnalytics();
    }

    // On page load, show login view.
    document.addEventListener('DOMContentLoaded', function() {
      updateNav();
      showView(currentUser ? 'dashboard' : 'login');
    });
  </script>
</body>
</html>